import{r as e,f as t,s as r,v as i,w as a,x as n,y as o,z as s,t as u,i as c,p as d,j as l,o as p}from"./index-DCtdVlbU.js";const m=e=>[e],y=(e,t={})=>[e,"list",{page:t.page??1,perPage:t.perPage??50,filter:t.filter||"",sort:t.sort||"",expand:t.expand||""}],f=(e,t)=>[e,"detail",t],g=e=>["staff_members","by_user",e];const h=new class{operationQueue;setOperationQueue;conflictCount;setConflictCount;constructor(){const[r,i]=e({operations:new Map,isProcessing:!1});this.operationQueue=r,this.setOperationQueue=i;const[a,n]=t(0);this.conflictCount=a,this.setConflictCount=n}generateOperationId(){return`op_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}addOperation(e){this.setOperationQueue("operations",t=>{const r=new Map(t);return r.set(e.id,e),r})}removeOperation(e){this.setOperationQueue("operations",t=>{const r=new Map(t);return r.delete(e),r})}getOperation(e){return this.operationQueue.operations.get(e)}hasConflictingOperations(e,t){return Array.from(this.operationQueue.operations.values()).some(r=>r.collection===e&&("pending"===r.status&&(!("delete"!==r.type||!t||r.recordId!==t)||!(!t||r.recordId!==t||"create"===r.type))))}getPendingOperations(e){return Array.from(this.operationQueue.operations.values()).filter(t=>t.collection===e&&"pending"===t.status).sort((e,t)=>e.timestamp-t.timestamp)}updateOperationStatus(e,t){this.getOperation(e)&&this.setOperationQueue("operations",r=>{const i=new Map(r),a=i.get(e);return a&&i.set(e,{...a,status:t}),i})}cleanup(){const e=Date.now();this.setOperationQueue("operations",t=>{const r=new Map;for(const[i,a]of t)e-a.timestamp<3e5&&r.set(i,a);return r})}getState(){return{queue:this.operationQueue,conflictCount:this.conflictCount()}}incrementConflictCount(){this.setConflictCount(e=>e+1)}};setInterval(()=>{h.cleanup()},6e4);var O=u('<div class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-lg text-xs max-w-sm"><div class="font-bold mb-2">Optimistic Operations</div><div>Pending: </div><div>Conflicts: '),b=u('<div class="mt-2 space-y-1">'),Q=u("<div> <!> (<!>)");function w(e,t){const o=r(),s=i();a(()=>{if(!t)return;let r=null;(async()=>{try{const i=r=>{switch(r.action){case"update":case"create":r.record?.id===t&&s.setQueryData(f(e,t),r.record);break;case"delete":r.record?.id===t&&s.removeQueries({queryKey:f(e,t)})}};r=await o.collection(e).subscribe(t,i)}catch(i){}})(),n(()=>{if(r)try{r()}catch{}})})}const S=()=>`temp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;function v(){const e=h.getState();return{pendingOperations:()=>Array.from(e.queue.operations.values()),conflictCount:e.conflictCount,isProcessing:()=>e.queue.isProcessing,hasPendingOperations:()=>e.queue.operations.size>0,getPendingForCollection:e=>h.getPendingOperations(e)}}function x(e,t={}){const i=r();return o(()=>({queryKey:g(e),queryFn:async()=>{if(!e)throw new Error("User ID is required");return await i.collection("staff_members").getFirstListItem(`user="${e}"`,{expand:t.expand})},enabled:!!e&&""!==e&&(t.enabled??!0),staleTime:3e5,gcTime:18e5,refetchOnWindowFocus:!1,retry:(e,t)=>404!==t?.status&&e<3,retryDelay:e=>Math.min(1e3*2**e,3e4)}))}function I(e,t={}){return x(e,{expand:"user,organization,clinic",enabled:t.enabled})}let D;D=Object.freeze(Object.defineProperty({__proto__:null,OptimisticDebugger:function(){const{pendingOperations:e,conflictCount:t,hasPendingOperations:r}=v();return(()=>{var i=O(),a=i.firstChild.nextSibling;a.firstChild;var n,o=a.nextSibling;return o.firstChild,c(a,()=>e().length,null),c(o,t,null),c(i,(n=d(()=>!!r()),()=>{return n()&&(t=b(),c(t,()=>e().slice(0,3).map(e=>{return t=Q(),r=t.firstChild,i=r.nextSibling,(a=i.nextSibling.nextSibling).nextSibling,c(t,()=>e.type,r),c(t,()=>e.collection,i),c(t,()=>e.status,a),l(()=>p(t,"text-xs p-1 rounded "+("pending"===e.status?"bg-yellow-600":"error"===e.status?"bg-red-600":"bg-green-600"))),t;var t,r,i,a})),t);var t}),null),i})()},useCreateMutation:function(e){const a=r(),n=i(),[o,u]=t(0);return s(()=>({mutationFn:async({data:t})=>await a.collection(e).create(t),onMutate:async t=>{const r=h.generateOperationId(),i=S(),a={id:r,type:"create",collection:e,recordId:i,timestamp:Date.now(),data:t.data,status:"pending"};h.addOperation(a),h.hasConflictingOperations(e)&&h.incrementConflictCount();try{await n.cancelQueries({queryKey:m(e)});const a=((e,t,r)=>{const i=r||S(),a=(new Date).toISOString();return{...t,id:i,created:a,updated:a,collectionId:`temp_${e}`,collectionName:e,expand:{}}})(e,t.data,i),o=[];return n.setQueriesData({queryKey:m(e),exact:!1},t=>{if(!t||!t.items)return t;const r=[...t.items],s=r.findIndex(e=>e.id===i||e.id.startsWith("temp_")&&JSON.stringify(e)===JSON.stringify(a));-1===s&&r.push(a);const u={...t,totalItems:-1===s?t.totalItems+1:t.totalItems,items:r};return o.push(()=>{n.setQueriesData({queryKey:m(e),exact:!1},t)}),u}),{operationId:r,optimisticRecord:a,rollbackFunctions:o}}catch(o){throw h.removeOperation(r),o}},onError:(t,r,i)=>{i&&(h.updateOperationStatus(i.operationId,"error"),i.rollbackFunctions.forEach(e=>{try{e()}catch(t){}}),u(e=>e+1),setTimeout(()=>{h.removeOperation(i.operationId)},1e3)),o()>3&&(n.invalidateQueries({queryKey:m(e)}),u(0))},onSuccess:(t,r,i)=>{if(i){h.updateOperationStatus(i.operationId,"success");try{n.setQueriesData({queryKey:m(e),exact:!1},e=>e&&e.items?{...e,items:e.items.map(e=>e.id===i.optimisticRecord?.id?t:e)}:e)}catch(a){n.invalidateQueries({queryKey:m(e)})}setTimeout(()=>{h.removeOperation(i.operationId)},1e3)}u(0)},onSettled:()=>{setTimeout(()=>{n.invalidateQueries({queryKey:m(e),exact:!1})},2e3)}}))},useCurrentUserStaffMember:function(e={}){const t=r();return x(t.authStore.model?.id,{...e,enabled:t.authStore.isValid&&(e.enabled??!0)})},useCurrentUserStaffMemberWithDetails:function(e={}){const t=r();return I(t.authStore.model?.id,{enabled:t.authStore.isValid&&(e.enabled??!0)})},useDeleteMutation:function(e){const a=r(),n=i(),[o,u]=t(0);return s(()=>({mutationFn:async({id:t})=>(await a.collection(e).delete(t),{id:t}),onMutate:async t=>{const r=h.generateOperationId(),i={id:r,type:"delete",collection:e,recordId:t.id,timestamp:Date.now(),status:"pending"};h.addOperation(i),h.hasConflictingOperations(e,t.id)&&(h.incrementConflictCount(),await new Promise(e=>setTimeout(e,100)));try{await n.cancelQueries({queryKey:m(e)});const i=new Map,a=[];return n.setQueriesData({queryKey:m(e),exact:!1},r=>{if(!r||!r.items)return r;const o=n.getQueryCache().find({queryKey:m(e),predicate:e=>e.state.data===r});if(o){const e=[...o.queryKey];i.set(e,r),a.push(()=>{n.setQueryData(e,r)})}const s=r.items.filter(e=>e.id!==t.id);return{...r,totalItems:Math.max(0,r.totalItems-1),items:s}}),{operationId:r,previousData:i,rollbackFunctions:a}}catch(a){throw h.removeOperation(r),a}},onError:(t,r,i)=>{i&&(h.updateOperationStatus(i.operationId,"error"),i.rollbackFunctions.forEach(e=>{try{e()}catch(t){}}),u(e=>e+1),setTimeout(()=>{h.removeOperation(i.operationId)},1e3)),o()>3&&(n.invalidateQueries({queryKey:m(e)}),u(0))},onSuccess:(e,t,r)=>{r&&(h.updateOperationStatus(r.operationId,"success"),setTimeout(()=>{h.removeOperation(r.operationId)},1e3)),u(0)},onSettled:()=>{setTimeout(()=>{n.invalidateQueries({queryKey:m(e),exact:!1})},2e3)}}))},useDetailQuery:function(e,t,i={}){const a=r();return o(()=>({queryKey:f(e,t),queryFn:async()=>await a.collection(e).getOne(t,{expand:i.expand}),enabled:!!t&&""!==t,staleTime:3e5,gcTime:18e5,retry:(e,t)=>404!==t?.status&&e<3}))},useListQuery:function(e,t={}){const i=r();return o(()=>({queryKey:y(e,t),queryFn:async()=>await i.collection(e).getList(t.page??1,t.perPage??50,{filter:t.filter,sort:t.sort,expand:t.expand}),staleTime:3e5,gcTime:18e5,refetchOnWindowFocus:!1,retry:(e,t)=>e<3,retryDelay:e=>Math.min(1e3*2**e,3e4)}))},useOptimisticState:v,useRealtimeRecordSubscription:w,useRealtimeSubscription:function(e){const o=r(),s=i(),[u,c]=t(!1),[d,l]=t(0);return a(()=>{let t=null,r=null;const i=async()=>{try{const r=t=>{switch(t.action){case"create":t.record?.id&&s.setQueryData(f(e,t.record.id),t.record),s.setQueriesData({queryKey:m(e),exact:!1},e=>{if(!e||!e.items||!t.record)return e;if(e.items.some(e=>e.id===t.record.id))return e;const r=[t.record,...e.items],i=e.perPage||r.length;return r.length>i&&(r.length=i),{...e,totalItems:e.totalItems+1,items:r}});break;case"update":t.record?.id&&s.setQueryData(f(e,t.record.id),t.record),s.setQueriesData({queryKey:m(e),exact:!1},e=>{if(!e||!e.items||!t.record?.id)return e;return e.items.some(e=>e.id===t.record.id)?{...e,items:e.items.map(e=>e.id===t.record.id?t.record:e)}:e});break;case"delete":t.record?.id&&s.removeQueries({queryKey:f(e,t.record.id)}),s.setQueriesData({queryKey:m(e),exact:!1},e=>e&&t.record?.id&&e.items?{...e,totalItems:Math.max(0,e.totalItems-1),items:e.items.filter(e=>e.id!==t.record.id)}:e);break;default:s.invalidateQueries({queryKey:m(e),exact:!1})}};t=await o.collection(e).subscribe("*",r),c(!0),l(0)}catch(a){c(!1);const e=d();if(e<5){const t=Math.min(1e3*Math.pow(2,e),3e4);r=window.setTimeout(()=>{l(e=>e+1),i()},t)}}};i(),n(()=>{if(t)try{t()}catch(e){}r&&clearTimeout(r),c(!1),l(0)})}),{isConnected:u,retryCount:d}},useStaffMemberByUser:x,useStaffMemberWithDetails:I,useUpdateMutation:function(e){const a=r(),n=i(),[o,u]=t(0);return s(()=>({mutationFn:async({id:t,data:r})=>await a.collection(e).update(t,r),onMutate:async t=>{const r=h.generateOperationId(),i={id:r,type:"update",collection:e,recordId:t.id,timestamp:Date.now(),data:t.data,status:"pending"};if(h.addOperation(i),h.hasConflictingOperations(e,t.id)){h.incrementConflictCount();h.getPendingOperations(e).filter(e=>e.recordId===t.id).length}try{await n.cancelQueries({queryKey:m(e)});const i=[],a=new Map;let o;n.setQueriesData({queryKey:m(e),exact:!1},r=>{if(!r||!r.items)return r;const o=n.getQueryCache().find({queryKey:m(e),predicate:e=>e.state.data===r});if(o){const e=[...o.queryKey];a.set(e,r),i.push(()=>{n.setQueryData(e,r)})}return{...r,items:r.items.map(e=>e.id===t.id?{...e,...t.data,updated:(new Date).toISOString()}:e)}});const s=f(e,t.id);if(o=n.getQueryData(s),o){const e={...o,...t.data,updated:(new Date).toISOString()};n.setQueryData(s,e),i.push(()=>{n.setQueryData(s,o)})}return{operationId:r,previousData:a,previousDetail:o,rollbackFunctions:i}}catch(a){throw h.removeOperation(r),a}},onError:(t,r,i)=>{i&&(h.updateOperationStatus(i.operationId,"error"),i.rollbackFunctions.forEach(e=>{try{e()}catch(t){}}),u(e=>e+1),setTimeout(()=>{h.removeOperation(i.operationId)},1e3)),o()>3&&(n.invalidateQueries({queryKey:m(e)}),u(0))},onSuccess:(t,r,i)=>{if(i){h.updateOperationStatus(i.operationId,"success");try{n.setQueriesData({queryKey:m(e),exact:!1},e=>e&&e.items?{...e,items:e.items.map(e=>e.id===r.id?t:e)}:e);const i=f(e,r.id);n.setQueryData(i,t)}catch(a){n.invalidateQueries({queryKey:m(e)})}setTimeout(()=>{h.removeOperation(i.operationId)},1e3)}u(0)},onSettled:()=>{setTimeout(()=>{n.invalidateQueries({queryKey:m(e),exact:!1})},2e3)}}))}},Symbol.toStringTag,{value:"Module"}));const{useListQuery:C,useDetailQuery:q,useCreateMutation:K,useUpdateMutation:M,useDeleteMutation:T,useRealtimeSubscription:F,useOptimisticState:P,OptimisticDebugger:_}=D;export{q as a,T as b,C as c,w as d,M as e,K as u};
